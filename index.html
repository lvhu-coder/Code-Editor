<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Browser Codespace Tabs</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
  <style>
    body, html { margin: 0; height: 100%; display: flex; flex-direction: column; font-family: sans-serif; background-color: #000; color: white; }
    #top-bar { padding: 5px; background: #111; display: flex; align-items: center; flex-wrap: wrap; gap: 5px; }
    input, button { padding: 3px; background: #222; color: white; border: 1px solid #333; }
    #container { display: flex; flex-direction: column; flex: 1; }
    #editor-container { flex: 2; display: flex; flex-direction: column; }
    #tabs { background: #111; display: flex; overflow-x: auto; }
    .tab { padding: 5px 10px; cursor: pointer; border-right: 1px solid #333; background: #111; color: white; white-space: nowrap; }
    .tab.active { background: #000; font-weight: bold; }
    #editor { flex: 1; }
    #terminal { flex: 1; background: #000; }
  </style>
  <!-- Monaco Editor -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.38.0/min/vs/loader.js"></script>
  <!-- xterm.js -->
  <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <!-- isomorphic-git -->
  <script src="https://cdn.jsdelivr.net/npm/isomorphic-git@1.21.2/dist/bundle.umd.min.js"></script>
  <!-- LightningFS -->
  <script src="https://cdn.jsdelivr.net/npm/lightning-fs@4.1.2/dist/lightning-fs.min.js"></script>
</head>
<body>
  <div id="top-bar">
    <label>GitHub Token:</label>
    <input type="password" id="token" placeholder="Personal Access Token" style="width:180px;">
    
    <label>Repo Name:</label>
    <input type="text" id="repoName" placeholder="e.g., my-repo" style="width:150px;">

    <button onclick="cloneRepo()">Clone Repo</button>
    <button onclick="commitAndPush()">Commit & Push</button>
    <button onclick="runJS()">Run JS</button>
    <button onclick="runPython()">Run Python</button>
    <button onclick="addNewTab()">New File</button>
  </div>

  <div id="container">
    <div id="editor-container">
      <div id="tabs"></div>
      <div id="editor"></div>
    </div>
    <div id="terminal"></div>
  </div>

  <script>
    // === Editor & Tabs Setup ===
    let editor;
    let files = {};
    let currentFile = null;
    const tabsDiv = document.getElementById('tabs');

    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.38.0/min/vs' }});
    require(['vs/editor/editor.main'], function() {
      editor = monaco.editor.create(document.getElementById('editor'), {
        value: '',
        language: 'javascript',
        theme: 'vs-dark',
        automaticLayout: true,
        fontSize: 14,
        fontFamily: 'Fira Code, monospace'
      });
      editor.onDidChangeModelContent(() => {
        if (currentFile) {
          files[currentFile] = editor.getValue();
          localStorage.setItem('browser-codespace-files', JSON.stringify(files));
        }
      });
    });

    function renderTabs() {
      tabsDiv.innerHTML = '';
      for (const file in files) {
        const tab = document.createElement('div');
        tab.className = 'tab';
        if (file === currentFile) tab.classList.add('active');
        tab.textContent = file;
        tab.onclick = () => switchTab(file);
        tabsDiv.appendChild(tab);
      }
    }

    function switchTab(file) {
      currentFile = file;
      editor.setValue(files[file]);
      if (file.endsWith('.js')) monaco.editor.setModelLanguage(editor.getModel(), 'javascript');
      else if (file.endsWith('.py')) monaco.editor.setModelLanguage(editor.getModel(), 'python');
      else monaco.editor.setModelLanguage(editor.getModel(), 'plaintext');
      renderTabs();
    }

    function addNewTab() {
      const fileName = prompt('Enter new file name (e.g., script.js):');
      if (!fileName) return;
      files[fileName] = '';
      switchTab(fileName);
      renderTabs();
    }

    const savedFiles = localStorage.getItem('browser-codespace-files');
    if (savedFiles) {
      files = JSON.parse(savedFiles);
      const firstFile = Object.keys(files)[0];
      if (firstFile) switchTab(firstFile);
      renderTabs();
    }

    // === Terminal Setup ===
    const term = new Terminal({ theme: { background: '#000', foreground: '#fff' } });
    term.open(document.getElementById('terminal'));
    term.writeln('Terminal Ready!');

    // === Pyodide Setup ===
    let pyodide;
    async function loadPyodideAndPackages() {
      pyodide = await loadPyodide();
      term.writeln('Python Ready!');
    }
    loadPyodideAndPackages();

    async function runJS() {
      const code = editor.getValue();
      try {
        const result = eval(code);
        term.writeln('JS Output: ' + result);
      } catch(err) {
        term.writeln('JS Error: ' + err);
      }
    }

    async function runPython() {
      const code = editor.getValue();
      if (!pyodide) { term.writeln('Pyodide not loaded yet!'); return; }
      try {
        const result = await pyodide.runPythonAsync(code);
        term.writeln('Python Output: ' + result);
      } catch(err) {
        term.writeln('Python Error: ' + err);
      }
    }

    // === Git + Browser FS Setup ===
    const fs = new LightningFS('fs');
    const pfs = fs.promises;
    const git = window.git;

    async function cloneRepo() {
      const token = document.getElementById('token').value;
      const repoName = document.getElementById('repoName').value.trim();
      if (!token || !repoName) return term.writeln('Missing token or repo name!');

      const remote = `https://${token}@github.com/lvhu-coder/${repoName}.git`;
      term.writeln(`Cloning https://github.com/lvhu-coder/${repoName}.git ...`);

      try {
        await git.clone({ fs: pfs, dir: '/', url: remote, singleBranch: true, depth: 1 });
        term.writeln('Clone successful!');

        const fileNames = await pfs.readdir('/');
        files = {};
        for (const file of fileNames) {
          try {
            const content = await pfs.readFile('/' + file, { encoding: 'utf8' });
            files[file] = content;
          } catch(e) {
            term.writeln(`Could not read file: ${file}`);
          }
        }
        const firstFile = Object.keys(files)[0];
        if (firstFile) switchTab(firstFile);
        renderTabs();
      } catch(err) {
        term.writeln('Clone failed: ' + err);
      }
    }

    async function commitAndPush() {
      const token = document.getElementById('token').value;
      if (!token) return term.writeln('Missing token!');
      const repoName = document.getElementById('repoName').value.trim();
      if (!repoName) return term.writeln('Missing repo name!');

      try {
        for (const file in files) {
          await pfs.writeFile('/' + file, files[file]);
          await git.add({ fs: pfs, dir: '/', filepath: file });
        }
        await git.commit({
          fs: pfs,
          dir: '/',
          message: 'Update from Browser Codespace',
          author: { name: 'lvhu-coder', email: 'lvhu-coder@example.com' }
        });
        const remote = `https://${token}@github.com/lvhu-coder/${repoName}.git`;
        await git.push({ fs: pfs, dir: '/', remote: remote, ref: 'main' });
        term.writeln('Push successful!');
      } catch(err) {
        term.writeln('Commit/Push failed: ' + err);
      }
    }
  </script>
</body>
</html>
